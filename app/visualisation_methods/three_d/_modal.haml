- parameters = @experiment.get_parameter_ids

- parameters_labels = parameters
- filter = {is_done: true, is_error: {'$exists'=> false}}
- fields = {fields: {result: 1}}
- result = @experiment.simulation_runs.where(filter, fields).first
- outputs=[]
- if result.blank?
  - outputs = ["No results found in completed simulation runs"]
- else
  - outputs = result.result.keys
  - notation_options = options_for_select([["Default", 'default'], ["Scientific", 'scientific']])
#threeDModal.reveal-modal(data-reveal="true")
  %section#threeD_charts_form.panel.radius.analysis-chart
    %a.close-reveal-modal &#215
    %h3.subheader="3d scatter plot charts"
    %h3 #{}
    .row
      .small-4.columns
        %label.inline="Select parameter for X axis"
      .small-4.columns
        %label.inline="Select parameter for Y axis"
      .small-4.columns
        %label.inline="Select parameter for Z axis"
    .row
      .small-4.columns
        %select.firstParam
          %optgroup{:label => "Parameters"}
            -parameters_labels.each do |parameter|
              %option{value:parameter} #{parameter}

          %optgroup{:label => "MoEs"}
            -outputs.each do |output|
              %option{value:output} #{output}
      .small-4.columns
        %select.secondParam
          %optgroup{:label => "Parameters"}
            -parameters_labels.each do |parameter|
              %option{value:parameter} #{parameter}

          %optgroup{:label => "MoEs"}
            -outputs.each do |output|
              %option{value:output} #{output}
      .small-4.columns
        %select.thirdParam
          %optgroup{:label => "Parameters"}
            -parameters_labels.each do |parameter|
              %option{value:parameter} #{parameter}

          %optgroup{:label => "MoEs"}
            -outputs.each do |output|
              %option{value:output} #{output}
    .row
      .small-4.columns
        %label.inline= label_tag :x_axis_notation, "Select notation for X axis" + ':', class: 'inline'
      .small-4.columns.end
        %label.inline= label_tag :y_axis_notation, "Select notation for Y axis" + ':', class: 'inline'
    .row
      .small-4.columns
        = select_tag 'x_axis_notation', notation_options
      .small-4.columns.end
        =select_tag 'y_axis_notation', notation_options
    .row
      %ul.inline-list
        %li
          %button.radius Load chart
        %li
          %img(src="#{image_url("loading.gif")}" id='busy_3d' size='16x16' style='display: none' )




  .charts
    .scripts

:javascript

  $(function(){

    $("#threeDModal").foundation("reveal", "close");

    var sessionGetJSON = function(url, params, onSuccess, onError) {
      return $.ajax({
       // dataType: "json",
        url: url,
        xhrFields: {
          withCredentials: true
        },
        success: onSuccess,
        error: (onError && onError()) || function(jqXHR, textStatus, errorThrown) {
          console.log("Error on request to " + url + ": " + textStatus + " " + errorThrown);
        }
      });
    };

    var three_d_chart_counter = 0;
    var scripts_loaded = false;


    var load_chart = function() {

      var three_d_chart_div = $("<div id=\"three_d_chart_"+three_d_chart_counter+"\">")[0];
      $("#threeDModal .charts").prepend(three_d_chart_div);
      //TODO - if there's nothing to select -> do nothing
      var x_axis = $("#threeDModal .firstParam option:selected").val();
      var y_axis = $("#threeDModal .secondParam option:selected").val();
      var z_axis = $("#threeDModal .thirdParam option:selected").val();
      var notationx =$("#threeDModal select[name=\'x_axis_notation\']").val();
      var notationy = $("#threeDModal select[name=\'y_axis_notation\']").val();
      var notation = [];
      notation[0] = notationx;
      notation[1] = notationy;
      var query_params = "experiment_id=#{@experiment.id}";
      query_params += "&param_x="+x_axis;
      query_params += "&param_y="+y_axis;
      query_params += "&param_z="+z_axis;
      query_params += "&chart_id="+three_d_chart_counter;
      query_params += "&notation="+notation;
      var url = "#{@prefix}/chart_instances/three_d?"+query_params;

      var handler = function(data) {
        $("#busy_3d").hide();
        var targetOffset = $(three_d_chart_div).offset().top;
        $('html,body').animate({ scrollTop: targetOffset }, 1000);
        $(three_d_chart_div).html(data);
      };
      sessionGetJSON(url, {}, handler);
      three_d_chart_counter++;

    };

    $("#threeDModal").find("button").bind("click", function() {
      $("#busy_3d").show();
      if(!scripts_loaded) {
        var url = "#{@prefix}/script_tags/three_d?base_url=" + encodeURIComponent("#{@prefix}");
        var handler = function(data) {
          scripts_loaded = true;
          $("#threeDModal").find(".scripts").html(data);
          load_chart();
        };
       sessionGetJSON(url, {}, handler);
      }
      else
        load_chart();
    });
  });
